# language setting
language: php

php:
# - 5.3
# - 5.4
 - 5.5
# - 5.6
# - hhvm

services:
  - mysql

before_install:
  - sudo apt-get update
  - sudo apt-get install nginx
  - sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm
  - sudo cp -f config/site-nginx.conf /etc/nginx/sites-enabled/site-nginx.conf
  - sudo sed -e "s?%BUILD_DIR%?$(pwd)?g" --in-place /etc/nginx/sites-enabled/site-nginx.conf
  - sudo service nginx start
  - sudo sh -c 'echo "[mysqld]" > /etc/mysql/conf.d/yafra.cnf'
  - sudo sh -c 'echo "lower_case_table_names=1" >> /etc/mysql/conf.d/yafra.cnf'
  - sudo mysqladmin shutdown
  - sudo su -c "/usr/bin/mysqld_safe > /dev/null 2>&1 &"
  - sudo mkdir -p /work/yafra-runtime
  - sudo mkdir -p /work/repos
  - cd /work/repos
  - sudo git clone https://github.com/yafraorg/yafra.git
  - sudo git clone https://github.com/yafraorg/yafra-database.git
  - cd
  - pwd

install:
  - composer self-update
  - composer install
  - npm install
  - node_modules/.bin/bower install


before_script: 
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - sudo -E /work/repos/yafra-database/build-db.sh mysql
  - pwd

script:
  - sudo ./build-shippable.sh
  - phpunit --log-junit shippable/testresults/junit.xml --coverage-xml shippable/codecoverage

after_script:
  - sudo service nginx stop

after_success:
   - echo $BUILD_NUMBER
   - sudo tar cvf /work/yafra-php-build.tar .
#   - sudo gzip /work/yafra-java-build.tar
#   - sudo curl -T /work/yafra-java-build.tar.gz -u yafrarel@yafra.org:eoCvvg9J ftp://ftp.yafra.org/
