# language setting
language: php

php:
# - 5.3
# - 5.4
 - 5.5
# - 5.6
# - hhvm

services:
  - mysql

# secure variables BINTRAYAPI, YAFRAFTPPWD
env:
  global:
    - YAFRABUILD=$BUILD_NUMBER
    - secure: gkTegEjroOTrGWzibwVG8pzdDqCmaAdJPwUVDM225kO6LLw8gedQ5IxlZOIfc+ttgXPahg1NEwA5jHuQFjv7A5aqFLkDXj6UnFOXLWVDckiobtknxOKaEXjeR4iS8PV3GZZy0x+Tne7M/ID0jxpptk1xScVLKN9X5fxCrm4Hut2SG6WNcB1s3Lcme6X9jBW9K+W7zV7e9//CPsDF3teBrH9nxpEWwFbBGtMzcS3at5sO2gK1m46LTIB1QLWUwFKcN3A4xy+oEa+2Mr4vDEZQlSc/QCUR9VgIouXf/F4M8jiKR1lSTgK8pbQbmNJkEBgWX8wDKiFObKfoxg7wqmFkZA==
    - secure: NMC7NqNRCOVqwfBqatvBSBj7jGvGzo45W8ZSgidlmdVO2xtyS92yQs6WVi2XIzsd16G40zMwIQHUq50Wi7caNGs2SzefyvSsNzbJ5XgwiB14vYBxh94tVxRQsazEoyuoPknNFYaL5yGhlBvckm/cRRXpaX9wk4GTMNDk+ebwXaUqclF+kZai18TM6AGnSlfsQL7NJ7UPw8aYZpc5pnHlmZR5+TCL4HEe8ZBe7NENPwA4ARxobMJA9OO+ZFd6BqLS+BqQwbFoCRRa4CrDpA3DXSFOR/q9yqPGSA51LYgUOtRPa11AndycniH91eTiBL+8WEwsPDkLVld0tRAchPSGpQ==

before_install:
  - pwd
  - sudo apt-get update
  - sudo apt-get install apache2 apache2-mpm-prefork apache2-utils libapache2-mod-php5 libapr1 libaprutil1 libpq5
  - sudo a2enmod rewrite
  - sudo service apache2 start
  - sudo mysqladmin password ""
  - sudo sh -c 'echo "[mysqld]" > /etc/mysql/conf.d/yafra.cnf'
  - sudo sh -c 'echo "lower_case_table_names=1" >> /etc/mysql/conf.d/yafra.cnf'
  - sudo mysqladmin shutdown
  - sudo su -c "/usr/bin/mysqld_safe > /dev/null 2>&1 &"
  - sudo mkdir -p /work/yafra-runtime
  - sudo mkdir -p /work/repos
  - cd /work/repos
  - sudo git clone https://github.com/yafraorg/yafra.git
  - sudo git clone https://github.com/yafraorg/yafra-database.git
  - cd
  - cd workspace/src/github.com/yafra-php

install:
  - pwd
  - composer self-update
  - composer install
  - npm -q install
  - node_modules/.bin/bower --quite install


before_script: 
  - pwd
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - sudo mysql -v -v </work/repos/yafra-database/yafradb/dbe_init_mysql.sql
  - sudo mysql -v -v </work/repos/yafra-database/yafradb/dbe_generate_mysql.sql

script:
  - sudo ./build-shippable.sh
  #TODO hangs - phpunit --log-junit shippable/testresults/junit.xml --coverage-xml shippable/codecoverage
  - phpunit --log-junit shippable/testresults/junit.xml

after_script:
  - sudo service apache2 stop

after_success:
  - pwd
  - echo $BUILD_NUMBER
  - sudo tar cvf /work/yafra-php-build.tar .
  - sudo gzip /work/yafra-php-build.tar
  - sudo -E cp /work/yafra-php-build.tar.gz /work/yafra-php-build-$BUILD_NUMBER.tar.gz
  - sudo curl -T /work/yafra-php-build-$BUILD_NUMBER.tar.gz -u yafraorg:$BINTRAYAPI https://api.bintray.com/content/yafraorg/yafra-distribution/yafra-php/v1.0/
  - sudo curl -T /work/yafra-php-build.tar.gz -u yafrarel@yafra.org:$YAFRAFTPPWD ftp://ftp.yafra.org/
